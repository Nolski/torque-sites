#!/bin/sh

# Load all the 100&Change proposals into a wiki.
#
# Copyright (C) 2017  Open Tech Strategies, LLC
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
# 
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
# 
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

##########################################################################
#                                                                        #
#   NOTE: This code is highly specific to the particular filenames and   #
#   working environment used by Open Tech Strategies on a project for    #
#   the MacArthur Foundation.  For our own convenience, we have left     #
#   those assumptions in place.  That means this script won't work if    #
#   someone else tries to run it; we publish it just as an example.      #
#   It is open source software, so please modify it to suit your needs.  #
#                                                                        #
##########################################################################

MACFOUND_DIR=`dirname "${0}"`

CSV2WIKI_CONFIG="${MACFOUND_DIR}"/csv2wiki-config

if [ ! -f "${CSV2WIKI_CONFIG}" ]; then
  echo "ERROR: No csv2wiki-config file found."
  echo ""
  echo "Try doing 'cp csv2wiki-config.tmpl csv2wiki-config' and"
  echo "then editing csv2wiki-config as needed.  The main thing"
  echo 'is to make sure the value of the "csv: " option is some'
  echo 'filename beginning with "sanitized-".  This script will'
  echo "look for the file without that prefix, sanitize it, and"
  echo "then run csv2wiki on the resultant CSV input, whose name"
  echo 'will be the same as the original but with the prefix'
  echo '"sanitized-".'
  echo ""
  exit 1
fi

# By the end of this conditional chain, ${CSV2WIKI} should point
# to the csv2wiki script.
CSV2WIKI=${OTSDIR}/clients/macarthur/eval-system/csv2wiki/csv2wiki
if [ ! -x ${CSV2WIKI} ]; then
  CSV2WIKI=`dirname ${MACFOUND_DIR}`/csv2wiki/csv2wiki
fi
if [ ! -x ${CSV2WIKI} ]; then
  CSV2WIKI=${OTSDIR}/clients/macarthur/eval-system/r/csv2wiki/csv2wiki
fi
if [ ! -x ${CSV2WIKI} ]; then
  CSV2WIKI=${OTSDIR}/csv2wiki/csv2wiki
fi
if [ ! -x ${CSV2WIKI} ]; then
  CSV2WIKI=${OTSDIR}/r/csv2wiki/csv2wiki
fi
if [ ! -x ${CSV2WIKI} ]; then
  # Okay, let's get medieval on the situation.
  git clone git@github.com:OpenTechStrategies/csv2wiki.git
  CSV2WIKI=`pwd`/csv2wiki/csv2wiki
fi
if [ ! -x ${CSV2WIKI} ]; then
  echo "ERROR: Unable to find or clone 'csv2wiki'."
  exit 1
fi

# Test that csv2wiki works.
if ${CSV2WIKI} --help > /dev/null; then
  echo "Great, it works." > /dev/null
else
  echo "ERROR: Problem running ${CSV2WIKI}."
  echo "Most likely you need to install the 'mwclient' and 'unidecode'"
  echo "Python modules.  Do 'sudo pip install mwclient' and"
  echo "'sudo pip install unidecode' and try running this script again."
  exit 1
fi

# In case we need this later.
OTS_TOOLS=`dirname ${CSV2WIKI}`

SANITIZER="${MACFOUND_DIR}"/fix-csv
SANITIZATION_PREFIX="sanitized-"
OPT_PREFIX_RE="^csv:[[:space:]]+${SANITIZATION_PREFIX}"
RAW_CSV=`grep -E "${OPT_PREFIX_RE}" ${CSV2WIKI_CONFIG} | sed -E "s|${OPT_PREFIX_RE}||"`
SANITIZED_CSV="`dirname ${RAW_CSV}`/${SANITIZATION_PREFIX}`basename ${RAW_CSV}`"

# First we're working on sanitization (wiki conversion comes later).
# Just convert 1% of the entries, to save time while testing.
echo "Sanitizing..."

${SANITIZER} --pare=100 "${RAW_CSV}" ${SANITIZED_CSV}
if [ $? -ne 0 ]; then
		echo Sanitization failure!
		exit 1
fi
echo "Done sanitizing."
echo ""

echo "Creating wiki..."
${CSV2WIKI} -c ${CSV2WIKI_CONFIG} ${SANITIZED_CSV}
echo "Done creating wiki."
echo ""
